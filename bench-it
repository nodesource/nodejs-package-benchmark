#!/bin/bash

NODEJS_PACKAGE_BENCHMARK_PATH="/usr/local/bin/nodejs-package-benchmark"

if [ -z "$1" ]; then
  echo "You must pass the binary as argument. Example: bench-it ./node";
  exit 1;
fi

BINARY=$1

if [ "$2" = "baseline" ]; then
  git rev-parse HEAD > baseline.out
  TTY=1 $BINARY "$NODEJS_PACKAGE_BENCHMARK_PATH/index.js" >> baseline.out;
  echo "Baseline generated.";
  exit 0;
fi

if [ ! -f ./baseline.out ]; then
  echo "The baseline.out does not exist. Generate it with: $ bench-it $BINARY baseline."
  exit 1;
fi

DIFF="colordiff";
if ! command -v colordiff &> /dev/null
then
    echo "⚠️ "colordiff" was not found. Using "diff" as fallback."
    DIFF="diff";
fi

TTY=1 $BINARY $NODEJS_PACKAGE_BENCHMARK_PATH/index.js > current.out;
$DIFF -y baseline.out current.out
